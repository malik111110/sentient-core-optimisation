# Action Plan: Story 1.1.2 - Core Agent Development & Execution Environment Setup

**Story ID:** 1.1.2
**Title:** Core Agent Development & Execution Environment Setup
**Assigned Agent:** AGENT-DEVOPS
**Dependencies:** T1.1.1 (AutoGen/AG2 + LangGraph Integration - for base agent classes and workflow concepts)
**Parent Epic:** 1.1 Multi-Agent Infrastructure Setup

## 1. Acceptance Criteria

- A standardized development environment is established using Docker and VS Code Dev Containers, supporting Python and Node.js runtimes.
- Git repository structure, a GitFlow-lite branching strategy, and Conventional Commits are implemented and documented.
- A CI/CD pipeline (GitHub Actions) is set up for automated linting (Ruff/Black/Prettier), type checking (MyPy), unit/integration testing (Pytest), and security scanning (Trivy).
- Dependency management is handled by Poetry (Python) and npm/yarn (Node.js), with consideration for an artifact repository (e.g., GitHub Packages, Nexus).
- A multi-runtime sandboxed execution environment is designed and implemented using Docker, featuring:
    - Distroless base images for Python and Node.js.
    - Non-root user execution within containers.
    - Enforced resource limits (CPU, memory, network).
    - Integrated security scanning of sandbox images with Trivy.
    - Centralized logging and basic monitoring for sandboxed executions.
- A secure API (e.g., FastAPI) is developed for deploying agent code/packages to and triggering executions within the sandboxed environment.
- A "hello-world" agent (Python-based) can be packaged, deployed via the API, executed in the sandbox, and its logs retrieved.

## 2. Detailed Tasks

This action plan expands on tasks T1.1.2.1 - T1.1.2.8 from `task-breakdown.md`, incorporating insights from `ai-development-environment.md` (ADE) and `archon-framework-integration.md` (AFI).

### Task 1.1.2.1: Standardized Development Environment Setup
   - **1.1.2.1.1:** Define base OS (e.g., Debian/Ubuntu LTS) and primary language versions (Python 3.11+, Node.js LTS).
   - **1.1.2.1.2:** Create `.devcontainer/devcontainer.json` and `Dockerfile` for VS Code Dev Containers. (ADE Section 3.1, 4.1)
      - Include Python (Poetry), Node.js (npm/yarn), Docker-in-Docker (for sandbox testing). 
      - Install common CLIs: Git, AWS CLI, Supabase CLI (if applicable).
   - **1.1.2.1.3:** Configure `.vscode/settings.json` for Python (Ruff, Black, MyPy, Pytest) and Node.js (ESLint, Prettier). (ADE Section 4.2)
   - **1.1.2.1.4:** Create `.vscode/extensions.json` with recommended extensions (Python, Pylance, Ruff, ESLint, Prettier, Docker, GitLens, etc.). (ADE Section 4.2)
   - **1.1.2.1.5:** Document dev environment setup and usage.

### Task 1.1.2.2: Git Repository and CI/CD Pipeline Setup
   - **1.1.2.2.1:** Initialize Git repository in `snoob-dev` with a comprehensive `.gitignore`.
   - **1.1.2.2.2:** Document GitFlow-lite branching strategy (`main`, `develop`, `feature/`, `fix/`, `chore/`) and Conventional Commits standard.
   - **1.1.2.2.3:** Set up GitHub Actions workflows (`.github/workflows/`) for:
      - **Lint & Format:** Ruff, Black (Python); ESLint, Prettier (Node.js/TS/MD).
      - **Type Check:** MyPy for Python.
      - **Unit & Integration Tests:** Pytest (with coverage reporting to Codecov/Coveralls).
      - **Security Scan:** Trivy for Docker images (dev container, sandbox base images).
   - **1.1.2.2.4:** Configure CI triggers (push/PR to `develop` and `main`).
   - **1.1.2.2.5:** Implement branch protection rules for `main` and `develop`.

### Task 1.1.2.3: Dependency Management and Artifact Repository
   - **1.1.2.3.1:** Initialize Poetry for Python projects within `snoob-dev` (e.g., `snoob-dev/src/core_agents/pyproject.toml`). (ADE Section 3.2)
   - **1.1.2.3.2:** Initialize npm/yarn for Node.js projects (e.g., for UI components or specific Node.js agents).
   - **1.1.2.3.3:** Pin dependency versions and use lockfiles (`poetry.lock`, `package-lock.json`).
   - **1.1.2.3.4:** Research and document strategy for publishing/consuming internal packages (e.g., using GitHub Packages, Nexus, or local Verdaccio for Node.js).
   - **1.1.2.3.5:** Integrate dependency vulnerability scanning (e.g., `poetry check --lock` with `safety`, `npm audit`).

### Task 1.1.2.4: Design Multi-Runtime Sandboxed Execution Environment
   - **1.1.2.4.1:** Design overall architecture for the sandboxed execution service (e.g., API layer, task queue, container orchestrator/manager). (ADE Section 2.1, 4.3)
   - **1.1.2.4.2:** Define communication protocols between the agent framework and the sandbox service (e.g., REST API for job submission, status checks, log retrieval).
   - **1.1.2.4.3:** Specify supported runtimes (initially Python, Node.js) and their versioning strategy within the sandbox.

### Task 1.1.2.5: Implement Sandbox Base Images and Security
   - **1.1.2.5.1:** Create minimal, distroless base Docker images for Python and Node.js runtimes. (ADE Section 4.3.1)
   - **1.1.2.5.2:** Ensure sandbox containers run with a non-root user. (ADE Section 4.3.2)
   - **1.1.2.5.3:** Implement mechanisms to enforce resource limits (CPU, memory, execution time, network access policies) per sandboxed job (e.g., using Docker run options or Kubernetes resource quotas). (ADE Section 4.3.3)
   - **1.1.2.5.4:** Integrate Trivy scanning into the CI/CD pipeline for these base sandbox images.
   - **1.1.2.5.5:** Design secure volume mounting strategy for agent code and data (read-only for code, restricted write for output).

### Task 1.1.2.6: Develop Secure API for Sandbox Interaction
   - **1.1.2.6.1:** Develop a FastAPI (Python) or Express.js (Node.js) service to manage sandbox operations.
   - **1.1.2.6.2:** Implement API endpoints for:
      - `POST /jobs`: Submit agent code/package and execution parameters.
      - `GET /jobs/{job_id}`: Check job status (pending, running, completed, failed).
      - `GET /jobs/{job_id}/logs`: Retrieve stdout/stderr logs from the execution.
      - `GET /jobs/{job_id}/results`: Retrieve execution output/artifacts.
   - **1.1.2.6.3:** Secure API endpoints (e.g., API keys, JWT authentication/authorization).
   - **1.1.2.6.4:** Implement input validation for all API requests.
   - **1.1.2.6.5:** Document the Sandbox API: endpoints, authentication, request/response schemas, and typical usage patterns for agent developers (covers sandbox usage part of T1.1.2.9).

### Task 1.1.2.7: Implement Sandbox Runtime Monitoring and Logging
   - **1.1.2.7.1:** Ensure stdout/stderr from sandboxed executions are captured and stored.
   - **1.1.2.7.2:** Integrate sandbox logs with a centralized logging system if available (e.g., ELK stack, Grafana Loki, or cloud provider logging services - see Story 1.1.6).
   - **1.1.2.7.3:** Implement basic monitoring for the sandbox service itself (e.g., API uptime, error rates, resource usage of the service).

### Task 1.1.2.8: "Hello World" Agent in Sandbox
   - **1.1.2.8.1:** Create a simple Python-based "hello-world" agent that logs a message and writes a small output file.
   - **1.1.2.8.2:** Package this agent (e.g., as a zip file with its dependencies or a minimal Docker image built on the Python sandbox base).
   - **1.1.2.8.3:** Use the Sandbox API (T1.1.2.6) to deploy and execute this agent.
   - **1.1.2.8.4:** Verify successful execution, log retrieval, and output file retrieval.
   - **1.1.2.8.5:** Test resource limit enforcement if possible with this simple agent.

## 3. Key Considerations & References

- **Security First:** Prioritize security in sandbox design, API implementation, and image creation. (ADE Section 4.3)
- **Isolation:** Ensure strong isolation between sandboxed agent executions.
- **Extensibility:** Design the sandbox to potentially support more runtimes or custom environments in the future.
- **Developer Experience:** While secure, the process of deploying and testing agents in the sandbox should be as smooth as possible for developers.
- **References:**
    - `ai-development-environment.md` (ADE): Dev Containers (3.1, 4.1), Poetry (3.2), VS Code (4.2), Sandbox concepts (2.1, 4.3).
    - `archon-framework-integration.md` (AFI): General Python project setup, logging, environment variables.
    - Official documentation for Docker, VS Code Dev Containers, GitHub Actions, Poetry, Trivy.
