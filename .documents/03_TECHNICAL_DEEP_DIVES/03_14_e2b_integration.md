# E2B Integration Guide

**ID:** guide:feature:e2b_integration  
**Source Reference(s):** https://e2b.dev/docs, https://github.com/e2b-dev/code-interpreter  
**Last Validated:** June 2025

---

## 1. Purpose
E2B provides fully-isolated, stateful compute sandboxes ("Desktops") for executing arbitrary code generated by AI agents. This guide explains how Sentient Core can embed E2B to power secure backend code execution, testing, and data-processing workflows.

## 2. Key Concepts
| Term | Description |
|------|-------------|
| **Desktop** | A long-lived container (VM) where code is executed. Supports Linux, Node.js, Python. |
| **Session Token** | Auth token obtained via API key or OAuth granting control over a Desktop. |
| **FS API** | Read/write files in the Desktop via REST/WebSocket. |
| **Exec API** | Spawn commands (`bash`, `python`, etc.) & stream stdio. |
| **Timeout / Quota** | Desktops auto-suspend after idle (default 30 min) and have CPU / RAM limits.

## 3. SDK Installation
```bash
# JS / TS
npm install @e2b/sdk
# Python (agents running server-side)
pip install e2b-code-interpreter
```
> NOTE: Do **not** bundle secret API keys in frontend code; proxy them via Sentient Core backend.

## 4. Authentication Flow
1. Obtain `E2B_API_KEY` (org or user scope).  
2. Backend calls `POST /v1/desktops` with `Authorization: Bearer <API_KEY>` to create Desktop.  
3. Returns `desktopId` & `wsUrl` for streaming.

## 5. Minimal JS Example
```ts
import { Desktop } from "@e2b/sdk";

const desktop = await Desktop.create({
  apiKey: process.env.E2B_API_KEY,
  template: "ubuntu",        // or custom image id
});

// Write a file
await desktop.fs.writeFile("script.py", "print('hello from E2B')\n");

// Execute it
const proc = await desktop.exec("python", ["script.py"]);
proc.stdout.on("data", chunk => console.log(chunk.toString()));
await proc.wait();

await desktop.close();
```

### Python Agent Example
```python
from e2b_code_interpreter import Desktop

desktop = Desktop.create(api_key=os.getenv("E2B_API_KEY"), template="ubuntu")
print(desktop.exec("python", "- << 'PY'\nprint('hi')\nPY"))
desktop.close()
```

## 6. Integration Patterns for Sentient Core
### 6.1 Single-Shot Tasks
* Agents require quick evaluation of small code snippets.  
* Use ephemeral Desktop (`lifecycle: "ephemeral"`).  
* Destroy immediately to save quota.

### 6.2 Long-Running Workflows
* Research or data ETL spanning minutes / hours.  
* Persist `desktopId` in task memory; reconnect between agent steps.

### 6.3 Code Implementation

The `E2BSandboxTool` located in `src/sentient_core/tools/e2b_sandbox_tool.py` provides a ready-to-use wrapper for agent interactions. It uses the following Pydantic model for its input:

```python
from pydantic import BaseModel
from typing import Literal

class E2BSandboxToolInput(BaseModel):
    language: Literal['python', 'node']
    script: str
```

This tool is the primary interface for any agent needing to execute code in an E2B sandbox.


## 7. Security & Governance
* **Network Egress**: Default allowed; lock down with E2B ACL if processing sensitive data.
* **Filesystem Isolation**: Each Desktop is isolated; share via explicit file upload only.
* **Resource Limits**: Monitor CPU / RAM via `desktop.metrics()`; enforce per-agent quotas.
* **Secrets Management**: Inject secrets at runtime via env vars, never hard-code.

## 8. Error Handling & Retries
| Scenario | Recommended Handling |
|----------|----------------------|
| Desktop quota exceeded | Fallback to WebContainer (client-side) or queue retry |
| Command exit ≠ 0 | Surface stderr to agent, classify retryable vs fatal |
| Lost WebSocket connection | Attempt `desktop.reconnect()` once, else fail gracefully |

## 9. Performance Tips
* Re-use a Desktop across related steps to avoid cold-start cost (~3-5 s).
* Batch filesystem writes using `desktop.fs.writeFiles()`.
* Stream stdout incrementally to update UI in near-real-time.

## 10. Use Cases in Sentient Core
1. **Backend Code Interpreter** – validate AI-generated backend logic safely.  
2. **Data Transformation** – run Pandas / PySpark jobs without local install.  
3. **Automated Tests** – execute pytest suite isolated from host.  
4. **Repository Analysis** – clone and inspect OSS repos inside Desktop.

## 11. Roadmap Alignment
| Milestone | How E2B Helps |
|-----------|---------------|
| Week 1-2 | Foundation – provide out-of-box backend sandbox |
| Week 3-4 | Multi-agent workflows – persist Desktop IDs per task |
| Week 5-6 | User-facing dashboards – stream output to UI via SSE/WebSocket |

## 12. References
* Official docs – <https://e2b.dev/docs>
* REST API – <https://e2b.dev/docs/api-reference>
* SDK GitHub – <https://github.com/e2b-dev/code-interpreter>
* Cookbook – <https://github.com/e2b-dev/e2b-cookbook>

---
*Prepared by Sentient Core Tech-Research agent, June 2025*
